#include <Arduino.h>
#include <Wire.h>
#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <WiFiClient.h>
#include <ESP8266WebServer.h>

#define echoPin 5
#define trigPin 4
#define speakerPin 2
#define SCLPin 13
#define SDAPin 12
#define INTPin 14

const char* ssid = "bot";
const char* password = "dankmemes";
ESP8266WebServer server(80);
int ID = -1;

boolean tb = true;
unsigned long myTime;

const int MPU6050_addr=0x68;
int16_t AccX,AccY,AccZ,Temp,GyroX,GyroY,GyroZ;

long sumR;
long sumL;

void setup() {
  Serial.begin(9600);
  sound_setup();
  internet_setup();
  delay(3000);
  //listen_sig(1000,500);
}
void loop() {
  server.handleClient();
}

void internet_setup(){
  WiFi.begin(ssid, password);

  // Wait for connection
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
  }
  while(ID < 0){
    pingServer();  
    delay(1000);
  }

  server.on("/", handleRoot);

  server.on("/loc", getPostData);
  server.onNotFound(handleNotFound);
  server.begin();
//  Serial.println("HTTP server started");
}

void getPostData(){
  String message = ""; message += millis();
  String body = server.arg("plain");
  server.send(200, "text/plain", message);
  int comma = body.indexOf(',');
  int postTime = body.substring(comma+1,body.indexOf(',', comma+1)).toInt();
  int postDelay = body.substring(body.indexOf(',', comma + 1)+1).toInt();  
  if(body.charAt(0) == 'l'){
    listen_sig(postTime, postDelay);
  }else if(body.charAt(0) == 's'){
    speaker_sig(postTime, postDelay);
  }
}

void handleRoot() {
  server.send(200, "text/plain", "hello from esp8266!");
}
void handleNotFound(){
  server.send(404, "text/plain", ":(");
}

void listen_sig(int postTime, int delayTime){
  byte outBuf[5];
  int half = 256;
  int full = half *2;
  int to_read = 16;
  byte inBuf[to_read*sizeof(short)];
  short samples[full];
  int ptr = 0;
  int count = 0;
  outBuf[0] = 'L';
  memcpy(outBuf+1, &postTime, 2);
  memcpy(outBuf+3, &delayTime, 2);
  Serial.write(outBuf,5);
  Serial.flush();
  delay((postTime+ delayTime)*2);
  while(ptr < full){
    if (Serial.available()>=to_read*sizeof(short)) {
      Serial.readBytes(inBuf, to_read*sizeof(short));
      for(int j = 0; j < to_read;j++)
        samples[j+ptr] = ((short *)inBuf)[j];
      ptr += to_read;
    } 
    delay(10);
  }
  String message = "{\"start\":";
  message += myTime;
  message += ",\"id\":";
  message += ID;
  message += ",\"left\":[";
  for(int i = 0; i < 255; i++){
    message+=samples[i];
    message+=",";
  }
  message+=samples[255];
  message += "],\"right\":[";
  for(int i = 0; i < 255; i++){
    message+=samples[i+256];
    message+=",";
  }
  message+=samples[511];
  message += "]}";
  sendLoc(message);
}

void speaker_sig(int postTime, int delayTime){
  delay(delayTime);
  analogWrite(speakerPin, 400);
  delay(postTime);
  analogWrite(speakerPin, 0);
  String message = "{\"id\":";
  message += ID;
  message +="}";
  sendLoc(message);
}

void usonic_setup(){
  pinMode(echoPin, INPUT);
  pinMode(trigPin, OUTPUT);
}

void sound_setup(){
  pinMode(speakerPin, OUTPUT);
  sumR = 0; sumL = 0;
}

void accel_setup(){
  Wire.begin();
  Wire.beginTransmission(MPU6050_addr);
  Wire.write(0x6B);
  Wire.write(0);
  Wire.endTransmission(true);
}

void pingServer(){
  HTTPClient http;
//  Serial.print("[HTTP] begin...\n");
  if (http.begin("http://192.168.1.186:42/reg")) {
        // start connection and send HTTP header
    myTime = millis();
    String message = "{\"clock\":";
    message += myTime;
    message += ",\"ip\":\"";
    message += WiFi.localIP().toString();
    message += "\"}";
    int httpCode = http.POST(message);
    if (httpCode > 0) {
      if (httpCode == HTTP_CODE_OK || httpCode == HTTP_CODE_MOVED_PERMANENTLY) {
        String payload = http.getString();
        ID = payload.toInt();
      }
    } else {
      Serial.printf("[HTTP] GET... failed, error: %s\n", http.errorToString(httpCode).c_str());
    }
    http.end();
  } else {
    Serial.printf("[HTTP} Unable to connect\n");
  }
}

void sendLoc(String message){
  HTTPClient http;
  if (http.begin("http://192.168.1.186:42/loc")) {
    int httpCode = http.POST(message);
    if (httpCode > 0) {
      if (httpCode == HTTP_CODE_OK || httpCode == HTTP_CODE_MOVED_PERMANENTLY) {
        String payload = http.getString();
      }
    } else {
      Serial.printf("[HTTP] GET... failed, error: %s\n", http.errorToString(httpCode).c_str());
    }
    http.end();
  } else {
    Serial.printf("[HTTP} Unable to connect\n");
  }
}

void test_usonic(){
  long duration, inches, cm;
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);
  // Reads the echoPin, returns the sound wave travel time in microseconds
  duration = pulseIn(echoPin, HIGH);
  inches = microsecondsToInches(duration);
  cm = microsecondsToCentimeters(duration);
  Serial.print(inches);
  Serial.print("in, ");
  Serial.print(cm);
  Serial.print("cm");
  Serial.println();
}

long microsecondsToInches(long microseconds) {
   return microseconds / 74 / 2;
}

long microsecondsToCentimeters(long microseconds) {
   return microseconds / 29 / 2;
}
